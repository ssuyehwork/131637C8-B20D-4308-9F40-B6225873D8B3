# -*- coding: utf-8 -*-# ui/tag_selector.pyfrom PyQt5.QtWidgets import QWidget, QVBoxLayout, QHBoxLayout, QCheckBox, QPushButton, QLineEdit, QScrollArea, QLabelfrom PyQt5.QtCore import Qt, pyqtSignal, QPointfrom PyQt5.QtGui import QCursorfrom core.config import COLORSclass TagSelectorFloat(QWidget):    """标签选择悬浮面板"""    tags_confirmed = pyqtSignal(list)  # 确认标签时发射信号        def __init__(self, db, idea_id, parent=None):        super().__init__(parent)        self.db = db        self.idea_id = idea_id        self.selected_tags = set()                # 设置窗口属性        self.setWindowFlags(            Qt.FramelessWindowHint |             Qt.WindowStaysOnTopHint |             Qt.Tool        )        self.setAttribute(Qt.WA_TranslucentBackground)        self.setAttribute(Qt.WA_ShowWithoutActivating, False)  # 允许获得焦点                self._init_ui()        self._load_tags()        def _init_ui(self):        # 主容器        container = QWidget()        container.setStyleSheet(f"""            QWidget {{                background-color: {COLORS['bg_dark']};                border: 2px solid {COLORS['primary']};                border-radius: 12px;            }}        """)                main_layout = QVBoxLayout(self)        main_layout.setContentsMargins(0, 0, 0, 0)        main_layout.addWidget(container)                layout = QVBoxLayout(container)        layout.setContentsMargins(15, 15, 15, 15)        layout.setSpacing(10)                # 标题栏        header = QHBoxLayout()        title = QLabel('🏷️ 快速选择标签')        title.setStyleSheet(f"""            font-size: 14px;             font-weight: bold;             color: {COLORS['primary']};            background: transparent;            border: none;        """)        header.addWidget(title)                close_btn = QPushButton('✕')        close_btn.setFixedSize(20, 20)        close_btn.setStyleSheet(f"""            QPushButton {{                background: transparent;                border: 1px solid #666;                border-radius: 10px;                color: #999;                font-size: 12px;                padding: 0px;            }}            QPushButton:hover {{                background-color: {COLORS['danger']};                border-color: {COLORS['danger']};                color: white;            }}        """)        close_btn.clicked.connect(self._on_close)        header.addWidget(close_btn)                layout.addLayout(header)                # 提示文字        hint = QLabel('💡 点击选择标签，失去焦点后自动保存')        hint.setStyleSheet("""            color: #888;             font-size: 11px;             background: transparent;            border: none;        """)        layout.addWidget(hint)                # 新建标签输入框        input_layout = QHBoxLayout()        self.new_tag_input = QLineEdit()        self.new_tag_input.setPlaceholderText('输入新标签...')        self.new_tag_input.setStyleSheet(f"""            QLineEdit {{                background-color: {COLORS['bg_mid']};                border: 1px solid {COLORS['bg_light']};                border-radius: 8px;                padding: 6px 10px;                color: #eee;                font-size: 12px;            }}            QLineEdit:focus {{                border: 1px solid {COLORS['primary']};            }}        """)        self.new_tag_input.returnPressed.connect(self._add_new_tag)        input_layout.addWidget(self.new_tag_input)                add_btn = QPushButton('➕')        add_btn.setFixedSize(28, 28)        add_btn.setStyleSheet(f"""            QPushButton {{                background-color: {COLORS['primary']};                border: none;                border-radius: 6px;                color: white;                font-size: 14px;            }}            QPushButton:hover {{                background-color: #357abd;            }}        """)        add_btn.clicked.connect(self._add_new_tag)        input_layout.addWidget(add_btn)                layout.addLayout(input_layout)                # 标签列表（滚动区域）        scroll = QScrollArea()        scroll.setWidgetResizable(True)        scroll.setFixedHeight(200)        scroll.setStyleSheet("""            QScrollArea {                border: none;                background: transparent;            }        """)                self.tag_list_widget = QWidget()        self.tag_list_layout = QVBoxLayout(self.tag_list_widget)        self.tag_list_layout.setAlignment(Qt.AlignTop)        self.tag_list_layout.setSpacing(6)        self.tag_list_layout.setContentsMargins(0, 0, 0, 0)                scroll.setWidget(self.tag_list_widget)        layout.addWidget(scroll)                # 统计信息        self.count_label = QLabel('已选择 0 个标签')        self.count_label.setStyleSheet(f"""            color: {COLORS['primary']};             font-size: 11px;             font-weight: bold;            background: transparent;            border: none;        """)        layout.addWidget(self.count_label)                # 设置固定宽度        self.setFixedWidth(300)        def _load_tags(self):        """加载所有可用标签"""        # 清空现有标签        while self.tag_list_layout.count():            item = self.tag_list_layout.takeAt(0)            if item.widget():                item.widget().deleteLater()                # 获取所有标签        c = self.db.conn.cursor()        c.execute('''            SELECT DISTINCT t.name, COUNT(it.idea_id) as cnt             FROM tags t            LEFT JOIN idea_tags it ON t.id = it.tag_id            LEFT JOIN ideas i ON it.idea_id = i.id AND i.is_deleted = 0            GROUP BY t.id            ORDER BY cnt DESC, t.name ASC        ''')        all_tags = c.fetchall()                # 获取当前灵感已有的标签        current_tags = set(self.db.get_tags(self.idea_id))        self.selected_tags = current_tags.copy()                if not all_tags:            empty = QLabel('暂无标签，请创建新标签')            empty.setStyleSheet("color: #666; font-style: italic; font-size: 11px;")            empty.setAlignment(Qt.AlignCenter)            self.tag_list_layout.addWidget(empty)        else:            for tag_name, count in all_tags:                checkbox = QCheckBox(f'{tag_name} ({count})')                checkbox.setChecked(tag_name in current_tags)                checkbox.setStyleSheet(f"""                    QCheckBox {{                        color: #ddd;                        font-size: 12px;                        spacing: 8px;                        background: transparent;                        border: none;                    }}                    QCheckBox::indicator {{                        width: 16px;                        height: 16px;                        border: 2px solid #666;                        border-radius: 4px;                        background-color: {COLORS['bg_mid']};                    }}                    QCheckBox::indicator:checked {{                        background-color: {COLORS['primary']};                        border-color: {COLORS['primary']};                        image: url(none);                    }}                    QCheckBox::indicator:hover {{                        border-color: {COLORS['primary']};                    }}                    QCheckBox:hover {{                        color: white;                    }}                """)                checkbox.stateChanged.connect(lambda state, name=tag_name: self._on_tag_changed(name, state))                self.tag_list_layout.addWidget(checkbox)                self._update_count()        def _on_tag_changed(self, tag_name, state):        """标签选择状态改变"""        if state == Qt.Checked:            self.selected_tags.add(tag_name)        else:            self.selected_tags.discard(tag_name)        self._update_count()        def _add_new_tag(self):        """添加新标签"""        tag_name = self.new_tag_input.text().strip()        if not tag_name:            return                # 检查是否已存在        c = self.db.conn.cursor()        c.execute('SELECT id FROM tags WHERE name = ?', (tag_name,))        if c.fetchone():            # 已存在，直接选中            self.selected_tags.add(tag_name)            self._load_tags()            self.new_tag_input.clear()            return                # 创建新标签        c.execute('INSERT INTO tags (name) VALUES (?)', (tag_name,))        self.db.conn.commit()                # 自动选中新标签        self.selected_tags.add(tag_name)                # 刷新列表        self._load_tags()        self.new_tag_input.clear()        def _update_count(self):        """更新已选择数量"""        count = len(self.selected_tags)        self.count_label.setText(f'已选择 {count} 个标签')        def _save_tags(self):        """保存标签到数据库"""        print(f"[DEBUG] 保存标签: {self.selected_tags}")                # 清空现有标签        c = self.db.conn.cursor()        c.execute('DELETE FROM idea_tags WHERE idea_id = ?', (self.idea_id,))                # 添加选中的标签        for tag_name in self.selected_tags:            c.execute('SELECT id FROM tags WHERE name = ?', (tag_name,))            result = c.fetchone()            if result:                tag_id = result[0]                c.execute('INSERT INTO idea_tags (idea_id, tag_id) VALUES (?, ?)',                          (self.idea_id, tag_id))                self.db.conn.commit()        print(f"[DEBUG] 标签保存完成")        def _on_close(self):        """手动关闭按钮"""        self._save_tags()        self.tags_confirmed.emit(list(self.selected_tags))        self.close()        def focusOutEvent(self, event):        """失去焦点时自动保存并关闭"""        print("[DEBUG] 标签选择器失去焦点，自动保存...")        self._save_tags()        self.tags_confirmed.emit(list(self.selected_tags))        self.close()        super().focusOutEvent(event)        def show_at_cursor(self):        """在鼠标位置显示"""        cursor_pos = QCursor.pos()        # 调整位置，避免超出屏幕        screen_geo = self.screen().geometry()                x = cursor_pos.x() + 10        y = cursor_pos.y() + 10                # 确保不超出屏幕右边界        if x + self.width() > screen_geo.right():            x = cursor_pos.x() - self.width() - 10                # 确保不超出屏幕底部        if y + self.height() > screen_geo.bottom():            y = screen_geo.bottom() - self.height() - 10                self.move(x, y)        self.show()        self.raise_()        self.activateWindow()        self.setFocus()