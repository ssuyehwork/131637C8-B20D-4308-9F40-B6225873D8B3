# -*- coding: utf-8 -*-# ui/common_tags_manager.pyfrom PyQt5.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QListWidget,                              QLineEdit, QPushButton, QLabel, QListWidgetItem,                              QMessageBox, QAbstractItemView, QSpinBox, QCheckBox, QWidget)from PyQt5.QtCore import Qt, QSizefrom core.config import COLORSfrom core.settings import load_setting, save_settingclass CommonTagsManager(QDialog):    """    常用标签管理界面 (高级版)    - 支持拖拽排序    - 支持勾选显隐    - 支持设置显示数量上限    """    def __init__(self, parent=None):        super().__init__(parent)                # 1. 加载数据 (兼容旧版本字符串列表)        raw_tags = load_setting('manual_common_tags', ['工作', '待办', '重要'])        self.tags_data = []        for item in raw_tags:            if isinstance(item, str):                self.tags_data.append({'name': item, 'visible': True})            elif isinstance(item, dict):                self.tags_data.append(item)                        # 加载数量限制        self.limit = load_setting('common_tags_limit', 5)                self.setWindowTitle("🏷️ 管理常用标签")        self.setWindowFlags(Qt.Dialog | Qt.FramelessWindowHint)        self.setAttribute(Qt.WA_TranslucentBackground)        self.setFixedSize(320, 480)                self._init_ui()        self._refresh_list()    def _init_ui(self):        # 主容器        container = QWidget(self)        container.setGeometry(0, 0, 320, 480)        container.setStyleSheet(f"""            QWidget {{                background-color: #252526;                border: 1px solid #444;                border-radius: 10px;                color: #EEE;            }}            QScrollBar:vertical {{ border: none; background: #2D2D2D; width: 6px; }}            QScrollBar::handle:vertical {{ background: #555; border-radius: 3px; }}        """)                layout = QVBoxLayout(container)        layout.setContentsMargins(15, 15, 15, 15)        layout.setSpacing(12)                # --- 标题栏 ---        header = QHBoxLayout()        title = QLabel("管理常用标签")        title.setStyleSheet("font-weight: bold; font-size: 14px; border: none;")        header.addWidget(title)                close_btn = QPushButton("×")        close_btn.setCursor(Qt.PointingHandCursor)        close_btn.setStyleSheet("QPushButton { border: none; font-size: 18px; color: #888; } QPushButton:hover { color: #FFF; }")        close_btn.clicked.connect(self._save_and_close) # 关闭时保存        header.addWidget(close_btn)        layout.addLayout(header)                # --- 添加输入框 ---        input_layout = QHBoxLayout()        self.inp_tag = QLineEdit()        self.inp_tag.setPlaceholderText("输入新标签名称...")        self.inp_tag.setStyleSheet(f"""            QLineEdit {{                background-color: #333; border: 1px solid #555; border-radius: 4px; padding: 6px; color: white;            }}            QLineEdit:focus {{ border-color: {COLORS['primary']}; }}        """)        self.inp_tag.returnPressed.connect(self._add_tag)                btn_add = QPushButton("添加")        btn_add.setCursor(Qt.PointingHandCursor)        btn_add.setStyleSheet(f"""            QPushButton {{                background-color: {COLORS['primary']}; color: white; border: none; border-radius: 4px; padding: 6px 12px;            }}            QPushButton:hover {{ background-color: #357ABD; }}        """)        btn_add.clicked.connect(self._add_tag)                input_layout.addWidget(self.inp_tag)        input_layout.addWidget(btn_add)        layout.addLayout(input_layout)                # --- 数量限制设置 ---        limit_layout = QHBoxLayout()        lbl_limit = QLabel("悬浮条最大显示数量:")        lbl_limit.setStyleSheet("color: #AAA; font-size: 12px; border:none;")                self.spin_limit = QSpinBox()        self.spin_limit.setRange(1, 10)        self.spin_limit.setValue(self.limit)        self.spin_limit.setFixedWidth(60)        self.spin_limit.setStyleSheet("""            QSpinBox { background-color: #333; border: 1px solid #555; color: white; padding: 4px; border-radius: 4px; }            QSpinBox::up-button, QSpinBox::down-button { background: none; border: none; }        """)                limit_layout.addWidget(lbl_limit)        limit_layout.addWidget(self.spin_limit)        limit_layout.addStretch()        layout.addLayout(limit_layout)                # --- 列表区 (核心交互) ---        lbl_hint = QLabel("💡 拖拽调整顺序，勾选控制显示")        lbl_hint.setStyleSheet("color: #666; font-size: 10px; border:none; margin-bottom: 2px;")        layout.addWidget(lbl_hint)        self.list_widget = QListWidget()        self.list_widget.setStyleSheet(f"""            QListWidget {{ background-color: #2D2D2D; border: 1px solid #444; border-radius: 4px; outline: none; }}            QListWidget::item {{ padding: 8px; color: #DDD; border-bottom: 1px solid #383838; }}            QListWidget::item:selected {{ background-color: #444; color: white; }}            QListWidget::indicator {{ width: 14px; height: 14px; border-radius: 3px; border: 1px solid #666; }}            QListWidget::indicator:checked {{ background-color: {COLORS['primary']}; border-color: {COLORS['primary']}; }}        """)        # 开启拖拽排序        self.list_widget.setDragDropMode(QAbstractItemView.InternalMove)        self.list_widget.setDefaultDropAction(Qt.MoveAction)        self.list_widget.setSelectionMode(QAbstractItemView.SingleSelection)                layout.addWidget(self.list_widget)                # --- 底部按钮 ---        btn_layout = QHBoxLayout()                btn_del = QPushButton("删除选中")        btn_del.setCursor(Qt.PointingHandCursor)        btn_del.setStyleSheet(f"""            QPushButton {{                background-color: #3E3E42; color: #DDD; border: 1px solid #555; border-radius: 4px; padding: 6px 12px;            }}            QPushButton:hover {{ background-color: {COLORS['danger']}; border-color: {COLORS['danger']}; color: white; }}        """)        btn_del.clicked.connect(self._del_tag)                btn_save = QPushButton("保存并关闭")        btn_save.setCursor(Qt.PointingHandCursor)        btn_save.setStyleSheet(f"""            QPushButton {{                background-color: {COLORS['primary']}; color: white; border: none; border-radius: 4px; padding: 6px 20px; font-weight: bold;            }}            QPushButton:hover {{ background-color: #357ABD; }}        """)        btn_save.clicked.connect(self._save_and_close)                btn_layout.addWidget(btn_del)        btn_layout.addStretch()        btn_layout.addWidget(btn_save)        layout.addLayout(btn_layout)                # 拖拽窗口支持        self.drag_pos = None    def _refresh_list(self):        """将数据渲染到列表"""        self.list_widget.clear()        for tag_data in self.tags_data:            item = QListWidgetItem(tag_data['name'])            # 开启复选框和拖拽标志            item.setFlags(item.flags() | Qt.ItemIsUserCheckable | Qt.ItemIsDragEnabled)            # 设置勾选状态            state = Qt.Checked if tag_data.get('visible', True) else Qt.Unchecked            item.setCheckState(state)            self.list_widget.addItem(item)    def _add_tag(self):        text = self.inp_tag.text().strip()        if not text: return                # 检查重复        for i in range(self.list_widget.count()):            if self.list_widget.item(i).text() == text:                QMessageBox.warning(self, "提示", "该标签已存在")                return                # 添加新项 (默认勾选)        item = QListWidgetItem(text)        item.setFlags(item.flags() | Qt.ItemIsUserCheckable | Qt.ItemIsDragEnabled)        item.setCheckState(Qt.Checked)        self.list_widget.addItem(item)        self.inp_tag.clear()        # 滚动到底部        self.list_widget.scrollToBottom()    def _del_tag(self):        row = self.list_widget.currentRow()        if row >= 0:            self.list_widget.takeItem(row)    def _save_and_close(self):        """保存当前列表顺序和状态到配置文件"""        new_tags_data = []        # 遍历 ListWidget，获取最新的顺序和勾选状态        for i in range(self.list_widget.count()):            item = self.list_widget.item(i)            new_tags_data.append({                'name': item.text(),                'visible': (item.checkState() == Qt.Checked)            })                    save_setting('manual_common_tags', new_tags_data)        save_setting('common_tags_limit', self.spin_limit.value())                self.accept()    # 窗口拖动逻辑    def mousePressEvent(self, event):        if event.button() == Qt.LeftButton:            self.drag_pos = event.globalPos() - self.frameGeometry().topLeft()            event.accept()    def mouseMoveEvent(self, event):        if event.buttons() == Qt.LeftButton and self.drag_pos:            self.move(event.globalPos() - self.drag_pos)            event.accept()